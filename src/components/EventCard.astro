---
import { generateGoogleCalendarUrl } from '../utils/ics';

interface Props {
  event: {
    id: string;
    type: 'corso' | 'regata' | 'evento_sociale';
    title: string;
    subtitle?: string;
    date: string;
    endDate?: string;
    time?: string;
    description: string;
    registrationUrl?: string;
    documents?: {
      bando?: string | null;
      iscrizione?: string | null;
      istruzioni?: string | null;
      classifica?: string | null;
    };
    status: 'open' | 'closed' | 'completed';
  };
  compact?: boolean;
}

const { event, compact = false } = Astro.props;

// Generate Google Calendar link
const calendarUrl = generateGoogleCalendarUrl({
  title: event.title,
  description: event.description,
  date: event.date,
  endDate: event.endDate,
  time: event.time,
  location: 'Circolo Nautico Cald√®, Via Maggiore 36, 21010 Castelveccana (VA)',
});

// Format date
function formatDate(dateStr: string): string {
  const date = new Date(dateStr);
  return date.toLocaleDateString('it-IT', {
    day: 'numeric',
    month: 'short',
  });
}

function formatFullDate(dateStr: string): string {
  const date = new Date(dateStr);
  return date.toLocaleDateString('it-IT', {
    weekday: 'long',
    day: 'numeric',
    month: 'long',
    year: 'numeric',
  });
}

// Type configuration
const typeConfig = {
  corso: {
    label: 'Corso',
    icon: '‚õµ',
    colorClass: 'bg-[var(--color-accent-primary)] dark:bg-[var(--color-accent-primary-dark)]',
    textClass: 'text-[var(--color-accent-primary)] dark:text-[var(--color-accent-primary-dark)]',
  },
  regata: {
    label: 'Regata',
    icon: 'üèÜ',
    colorClass: 'bg-[var(--color-accent-secondary)] dark:bg-[var(--color-accent-secondary-dark)]',
    textClass: 'text-[var(--color-accent-secondary)] dark:text-[var(--color-accent-secondary-dark)]',
  },
  evento_sociale: {
    label: 'Evento',
    icon: 'ü•Ç',
    colorClass: 'bg-[var(--color-accent-tertiary)] dark:bg-[var(--color-accent-tertiary-dark)]',
    textClass: 'text-[var(--color-accent-tertiary)] dark:text-[var(--color-accent-tertiary-dark)]',
  },
};

const config = typeConfig[event.type];
const dateDisplay = event.endDate 
  ? `${formatDate(event.date)} - ${formatDate(event.endDate)}`
  : formatDate(event.date);
---

<article class:list={[
  "bg-[var(--color-bg-primary)] dark:bg-[var(--color-bg-secondary-dark)] rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden transition-shadow hover:shadow-lg",
  { "p-4": compact, "p-6": !compact }
]}>
  <div class="flex items-start gap-4">
    <!-- Date Badge -->
    <div class="flex-shrink-0 text-center">
      <div class:list={[
        "rounded-lg px-3 py-2",
        config.colorClass
      ]}>
        <span class="text-white text-lg" aria-hidden="true">{config.icon}</span>
      </div>
      <p class="mt-2 text-sm font-bold">{formatDate(event.date)}</p>
    </div>
    
    <!-- Content -->
    <div class="flex-1 min-w-0">
      <!-- Type Badge -->
      <span class:list={[
        "inline-flex items-center gap-1 text-xs font-semibold uppercase tracking-wide",
        config.textClass
      ]}>
        {config.label}
      </span>
      
      <!-- Title -->
      <h3 class:list={[
        "font-bold text-[var(--color-text-primary)] dark:text-[var(--color-text-primary-dark)] mt-1",
        { "text-base": compact, "text-lg": !compact }
      ]}>
        {event.title}
      </h3>
      
      {event.subtitle && (
        <p class="text-sm text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)]">
          {event.subtitle}
        </p>
      )}
      
      {!compact && (
        <>
          <!-- Date & Time -->
          <p class="text-sm text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)] mt-2">
            <time datetime={event.date}>{dateDisplay}</time>
            {event.time && ` ‚Ä¢ ${event.time}`}
          </p>
          
          <!-- Description -->
          <p class="text-sm text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)] mt-2 line-clamp-2">
            {event.description}
          </p>
          
          <!-- Actions -->
          <div class="flex flex-wrap gap-2 mt-4">
            {event.registrationUrl && event.status === 'open' && (
              <a
                href={event.registrationUrl}
                class="inline-flex items-center px-4 py-2 bg-[var(--color-accent-secondary)] dark:bg-[var(--color-accent-secondary-dark)] text-white font-bold text-sm uppercase tracking-wide rounded-lg hover:opacity-90 transition-opacity touch-target"
              >
                Iscriviti
              </a>
            )}
            
            <!-- Add to Calendar -->
            <a
              href={calendarUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center gap-1 px-3 py-2 border border-gray-300 dark:border-gray-600 text-sm rounded-lg hover:bg-[var(--color-bg-secondary)] dark:hover:bg-[var(--color-bg-accent-dark)] transition-colors touch-target"
              title="Aggiungi a Google Calendar"
            >
              üìÖ Salva in Agenda
            </a>
            
            {event.type === 'regata' && event.documents && (
              <div class="flex flex-wrap gap-2">
                {event.documents.bando && (
                  <a
                    href={event.documents.bando}
                    class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 text-sm rounded-lg hover:bg-[var(--color-bg-secondary)] dark:hover:bg-[var(--color-bg-accent-dark)] transition-colors touch-target"
                    target="_blank"
                    rel="noopener noreferrer"
                  >
                    üìÑ Bando
                  </a>
                )}
                {event.documents.iscrizione && (
                  <a
                    href={event.documents.iscrizione}
                    class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 text-sm rounded-lg hover:bg-[var(--color-bg-secondary)] dark:hover:bg-[var(--color-bg-accent-dark)] transition-colors touch-target"
                    target="_blank"
                    rel="noopener noreferrer"
                  >
                    üìù Iscrizione
                  </a>
                )}
              </div>
            )}
          </div>
        </>
      )}
    </div>
  </div>
</article>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

