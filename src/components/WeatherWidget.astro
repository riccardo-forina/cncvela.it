---
// Weather widget for CaldÃ¨, Lake Maggiore
// Coordinates: 45.9667, 8.6667
---

<a href="meteo" class="weather-widget flex items-center gap-1.5 text-sm hover:text-[var(--color-accent-primary)] dark:hover:text-[var(--color-accent-primary-dark)] transition-colors" title="Vedi previsioni meteo">
  <!-- Wind Icon -->
  <span class="text-base" aria-hidden="true">ðŸ’¨</span>
  
  <!-- Loading state -->
  <span class="weather-loading text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)]">
    --
  </span>
  
  <!-- Weather data (hidden until loaded) -->
  <span class="weather-data hidden font-medium">
    <span class="wind-speed">--</span>
    <span class="text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)] text-xs">kn</span>
    <span class="wind-direction ml-1 text-xs text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)]"></span>
  </span>
</a>

<script>
  // Only run once, even if component is included multiple times
  if (!window.weatherWidgetInitialized) {
    window.weatherWidgetInitialized = true;
    
    // CaldÃ¨ coordinates (CNC - Via Maggiore 36)
    const LAT = 45.9448;
    const LON = 8.6612;
    
    // Wind direction to compass
    function degToCompass(deg: number): string {
      const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
      const index = Math.round(deg / 45) % 8;
      return directions[index];
    }
    
    async function fetchWeather() {
      try {
        const response = await fetch(
          `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&current=wind_speed_10m,wind_direction_10m&wind_speed_unit=kn`
        );
        
        if (!response.ok) throw new Error('Weather fetch failed');
        
        const data = await response.json();
        const windSpeed = Math.round(data.current.wind_speed_10m);
        const windDir = degToCompass(data.current.wind_direction_10m);
        
        // Update ALL weather widgets on the page
        document.querySelectorAll('.weather-widget').forEach(widget => {
          const loadingEl = widget.querySelector('.weather-loading');
          const dataEl = widget.querySelector('.weather-data');
          const speedEl = widget.querySelector('.wind-speed');
          const dirEl = widget.querySelector('.wind-direction');
          
          if (loadingEl && dataEl && speedEl && dirEl) {
            loadingEl.classList.add('hidden');
            dataEl.classList.remove('hidden');
            speedEl.textContent = windSpeed.toString();
            dirEl.textContent = windDir;
          }
        });
      } catch (error) {
        console.error('Weather fetch error:', error);
        // Keep showing "--" on error
      }
    }
    
    // Fetch on load
    fetchWeather();
    
    // Refresh every 10 minutes
    setInterval(fetchWeather, 10 * 60 * 1000);
  }
</script>

