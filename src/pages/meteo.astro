---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getEntry } from 'astro:content';

// Get page content
const page = await getEntry('pages', 'meteo');

// Cald√® coordinates
const LAT = 45.9667;
const LON = 8.6667;
---

<BaseLayout title={page.data.title} description={page.data.description}>
  <!-- Hero -->
  <section class="relative bg-[var(--color-accent-primary)] dark:bg-[var(--color-accent-primary-dark)] pt-10 md:pt-14 pb-16 md:pb-20 overflow-hidden">
    <!-- Wave pattern -->
    <div class="absolute inset-0 pointer-events-none mix-blend-soft-light opacity-50" aria-hidden="true">
      <img src="images/wave-pattern.jpg" alt="" class="w-full h-full object-cover" />
    </div>
    <div class="relative max-w-6xl mx-auto px-4 lg:px-6">
      <div class="inline-block bg-[var(--color-accent-primary)] px-6 py-4 rounded-lg">
        <h1 class="text-3xl md:text-4xl font-black text-white" style="font-size: var(--text-3xl);">
          {page.data.title}
        </h1>
      </div>
    </div>
    <!-- Wave Divider -->
    <div class="absolute bottom-0 left-0 right-0">
      <svg viewBox="0 0 1440 120" fill="none" preserveAspectRatio="none" class="w-full h-12 md:h-16">
        <path d="M0 120L60 110C120 100 240 80 360 70C480 60 600 60 720 65C840 70 960 80 1080 85C1200 90 1320 90 1380 90L1440 90V120H1380C1320 120 1200 120 1080 120C960 120 840 120 720 120C600 120 480 120 360 120C240 120 120 120 60 120H0Z" fill="var(--color-bg-primary)" class="dark:fill-[var(--color-bg-primary-dark)]"/>
      </svg>
    </div>
  </section>

  <!-- Intro -->
  <section class="py-8 border-b border-gray-200 dark:border-gray-800">
    <div class="max-w-6xl mx-auto px-4 lg:px-6">
      <p class="text-lg text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)] max-w-3xl">
        {page.data.subtitle}
      </p>
    </div>
  </section>

  <!-- Current Conditions & Sailing Assessment -->
  <section class="py-12 md:py-16">
    <div class="max-w-4xl mx-auto px-4 lg:px-6">
      
      <!-- Combined Weather Card -->
      <div class="bg-[var(--color-bg-primary)] dark:bg-[var(--color-bg-secondary-dark)] rounded-2xl border border-gray-200 dark:border-gray-700 p-6 md:p-8 mb-8">
        
        <h2 class="text-xl font-bold mb-6">
          Condizioni per la Vela
        </h2>
        
        <!-- Sailing Status Banner -->
        <div id="sailing-banner" class="rounded-xl p-4 mb-6 text-center bg-gray-100 dark:bg-gray-800">
          <p class="text-2xl font-black" id="wind-status">--</p>
          <p class="text-sm text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)]">
            Consigliato per: <span id="recommended-for" class="font-semibold">--</span>
          </p>
        </div>
        
        <!-- Weather Stats Grid -->
        <div id="current-weather" class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
          <div class="text-center p-4 bg-secondary rounded-xl">
            <p class="text-3xl md:text-4xl font-black text-[var(--color-accent-primary)] dark:text-[var(--color-accent-primary-dark)]">
              <span id="current-wind-speed">--</span><span class="text-lg md:text-xl font-bold ml-1">kn</span>
            </p>
            <p class="text-xs md:text-sm text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)]">vento</p>
          </div>
          <div class="text-center p-4 bg-secondary rounded-xl">
            <p class="text-3xl md:text-4xl font-black text-[var(--color-accent-secondary)] dark:text-[var(--color-accent-secondary-dark)]" id="current-wind-dir">--</p>
            <p class="text-xs md:text-sm text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)]">direzione</p>
          </div>
          <div class="text-center p-4 bg-secondary rounded-xl">
            <p class="text-3xl md:text-4xl font-black">
              <span id="current-temp">--</span><span class="text-lg md:text-xl font-bold ml-1">¬∞C</span>
            </p>
            <p class="text-xs md:text-sm text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)]">temperatura</p>
          </div>
          <div class="text-center p-4 bg-secondary rounded-xl">
            <p class="text-3xl md:text-4xl font-black">
              <span id="current-humidity">--</span><span class="text-lg md:text-xl font-bold ml-1">%</span>
            </p>
            <p class="text-xs md:text-sm text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)]">umidit√†</p>
          </div>
        </div>
        
        <p class="text-xs text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)] mt-4 text-center" id="last-update">
          Aggiornato: --
        </p>
      </div>

      <!-- Hourly Forecast -->
      <div class="bg-[var(--color-bg-primary)] dark:bg-[var(--color-bg-secondary-dark)] rounded-2xl border border-gray-200 dark:border-gray-700 p-6 md:p-8 mb-8">
        <h2 class="text-lg font-bold mb-4">
          Previsione Vento Oggi
        </h2>
        
        <div id="hourly-forecast" class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-12 gap-2">
          <!-- Will be populated by JS -->
          <p class="col-span-full text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)]">Caricamento...</p>
        </div>
        
        <p class="text-xs text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)] mt-4">
          ‚ö†Ô∏è Indicazioni generali. Verifica sempre le condizioni reali prima di uscire.
        </p>
      </div>

      <!-- Data Source -->
      <p class="text-center text-xs text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)] mt-8">
        Dati meteo forniti da <a href="https://open-meteo.com/" target="_blank" rel="noopener noreferrer" class="underline hover:text-[var(--color-accent-primary)]">Open-Meteo</a>
      </p>
    </div>
  </section>
</BaseLayout>

<script define:vars={{ LAT, LON }}>
  // Wind direction to compass
  function degToCompass(deg) {
    const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
    const index = Math.round(deg / 45) % 8;
    return directions[index];
  }

  // Get wind status, recommendation, and color (thresholds in knots)
  function getWindConditions(speed) {
    if (speed < 3) {
      return { status: 'üîµ Bonaccia', recommendation: 'Principianti, SUP', bgClass: 'bg-blue-100 dark:bg-blue-900/40' };
    } else if (speed < 7) {
      return { status: 'üü¢ Vento Leggero', recommendation: 'Tutti i livelli', bgClass: 'bg-green-100 dark:bg-green-900/40' };
    } else if (speed < 11) {
      return { status: 'üü° Vento Moderato', recommendation: 'Velisti esperti', bgClass: 'bg-yellow-100 dark:bg-yellow-900/40' };
    } else if (speed < 16) {
      return { status: 'üü† Vento Forte', recommendation: 'Solo esperti', bgClass: 'bg-orange-100 dark:bg-orange-900/40' };
    } else {
      return { status: 'üî¥ Vento Molto Forte', recommendation: 'Sconsigliato uscire', bgClass: 'bg-red-100 dark:bg-red-900/40' };
    }
  }

  async function fetchWeather() {
    try {
      const response = await fetch(
        `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&current=temperature_2m,relative_humidity_2m,wind_speed_10m,wind_direction_10m&hourly=wind_speed_10m,wind_direction_10m&wind_speed_unit=kn&timezone=Europe/Rome&forecast_days=1`
      );
      
      if (!response.ok) throw new Error('Weather fetch failed');
      
      const data = await response.json();
      
      // Update current conditions
      const windSpeed = Math.round(data.current.wind_speed_10m);
      const windDir = degToCompass(data.current.wind_direction_10m);
      const temp = Math.round(data.current.temperature_2m);
      const humidity = Math.round(data.current.relative_humidity_2m);
      
      document.getElementById('current-wind-speed').textContent = windSpeed;
      document.getElementById('current-wind-dir').textContent = windDir;
      document.getElementById('current-temp').textContent = temp;
      document.getElementById('current-humidity').textContent = humidity;
      
      // Update timestamp
      const now = new Date();
      document.getElementById('last-update').textContent = 
        `Aggiornato: ${now.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' })}`;
      
      // Update sailing conditions banner
      const conditions = getWindConditions(windSpeed);
      const banner = document.getElementById('sailing-banner');
      document.getElementById('wind-status').textContent = conditions.status;
      document.getElementById('recommended-for').textContent = conditions.recommendation;
      
      // Update banner background color
      banner.className = `rounded-xl p-4 mb-6 text-center ${conditions.bgClass}`;
      
      // Update hourly forecast
      const hourlyContainer = document.getElementById('hourly-forecast');
      const currentHour = new Date().getHours();
      
      let hourlyHTML = '';
      
      for (let i = currentHour; i < Math.min(currentHour + 12, 24); i++) {
        const hour = data.hourly.time[i].split('T')[1].substring(0, 5);
        const speed = Math.round(data.hourly.wind_speed_10m[i]);
        const dir = degToCompass(data.hourly.wind_direction_10m[i]);
        
        // Color based on wind speed (knots)
        let bgColor = 'bg-blue-100 dark:bg-blue-900/30';
        if (speed >= 3 && speed < 7) bgColor = 'bg-green-100 dark:bg-green-900/30';
        else if (speed >= 7 && speed < 11) bgColor = 'bg-yellow-100 dark:bg-yellow-900/30';
        else if (speed >= 11 && speed < 16) bgColor = 'bg-orange-100 dark:bg-orange-900/30';
        else if (speed >= 16) bgColor = 'bg-red-100 dark:bg-red-900/30';
        
        hourlyHTML += `
          <div class="text-center p-2 rounded-lg ${bgColor}">
            <p class="text-xs text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)]">${hour}</p>
            <p class="text-base font-bold">${speed}<span class="text-[10px] font-medium ml-0.5">kn</span></p>
            <p class="text-xs font-medium">${dir}</p>
          </div>
        `;
      }
      
      hourlyContainer.innerHTML = hourlyHTML;
      
    } catch (error) {
      console.error('Weather fetch error:', error);
      document.getElementById('hourly-forecast').innerHTML = 
        '<p class="text-red-500">Errore nel caricamento dei dati meteo</p>';
    }
  }
  
  // Fetch on load
  fetchWeather();
  
  // Refresh every 10 minutes
  setInterval(fetchWeather, 10 * 60 * 1000);
</script>

