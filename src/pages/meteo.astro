---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getEntry } from 'astro:content';

// Get page content
const page = await getEntry('pages', 'meteo');

// CaldÃ¨ coordinates (CNC - Via Maggiore 36)
const LAT = 45.9448;
const LON = 8.6612;
---

<BaseLayout title={page.data.title} description={page.data.description}>
  <!-- Title bar -->
  <section class="bg-[var(--color-accent-primary)] dark:bg-[var(--color-accent-primary-dark)] py-6 md:py-8">
    <div class="max-w-6xl mx-auto px-4 lg:px-6">
      <h1 class="text-2xl md:text-3xl font-black text-white">{page.data.title}</h1>
      {page.data.subtitle && (
        <p class="text-sm md:text-base text-white/70 mt-2 max-w-2xl">{page.data.subtitle}</p>
      )}
    </div>
  </section>

  <!-- Legend & Source Box -->
  <section class="py-8 md:py-12">
    <div class="max-w-6xl mx-auto px-4 lg:px-6">
      <div class="bg-secondary rounded-xl p-4 md:p-6">
        <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
          <!-- Legend -->
          <div>
            <p class="text-sm font-medium mb-1">Legenda intensitÃ  vento</p>
            <p class="text-xs text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)] mb-3">Il colore indica lo sfondo usato nelle previsioni</p>
            <div class="grid grid-cols-2 sm:grid-cols-5 gap-3 text-sm">
              <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-sky-500 flex-shrink-0"></span>
                <span>&lt;3 kn Bonaccia</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-emerald-500 flex-shrink-0"></span>
                <span>3-7 kn Leggero</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-amber-500 flex-shrink-0"></span>
                <span>7-11 kn Moderato</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-orange-500 flex-shrink-0"></span>
                <span>11-16 kn Forte</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-red-500 flex-shrink-0"></span>
                <span>&gt;16 kn Molto forte</span>
              </div>
            </div>
          </div>
          
          <!-- Data Source -->
          <div class="text-xs text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)] md:text-right md:min-w-[200px]">
            <p class="font-medium text-[var(--color-text-primary)] dark:text-[var(--color-text-primary-dark)]">Fonte dati</p>
            <p><a href="https://open-meteo.com/" target="_blank" rel="noopener noreferrer" class="underline hover:text-[var(--color-accent-primary)]">Open-Meteo API</a></p>
            <p class="mt-1">Posizione: <a href="https://maps.app.goo.gl/HrvN1bRb2mzhJw1n6" target="_blank" rel="noopener noreferrer" class="underline hover:text-[var(--color-accent-primary)]">CNC CaldÃ¨</a></p>
            <p>Modello: ECMWF</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Current Conditions & Sailing Assessment -->
  <section class="pb-12 md:pb-16">
    <div class="max-w-4xl mx-auto px-4 lg:px-6">
      
      <!-- Combined Weather Card -->
      <div class="bg-[var(--color-bg-primary)] dark:bg-[var(--color-bg-secondary-dark)] rounded-2xl border border-gray-200 dark:border-gray-700 p-6 md:p-8 mb-8">
        
        <h2 class="text-xl font-bold mb-6">
          Condizioni per la Vela
        </h2>
        
        <!-- Sailing Status Banner -->
        <div id="sailing-banner" class="rounded-xl p-4 mb-6 text-center bg-gray-100 dark:bg-gray-800">
          <p class="text-2xl font-black" id="wind-status">--</p>
          <p class="text-sm text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)]">
            Consigliato per: <span id="recommended-for" class="font-semibold">--</span>
          </p>
        </div>
        
        <!-- Weather Stats Grid -->
        <div id="current-weather" class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
          <div class="text-center p-4 bg-secondary rounded-xl">
            <p class="text-3xl md:text-4xl font-black text-[var(--color-accent-primary)] dark:text-[var(--color-link-dark)]">
              <span id="current-wind-speed">--</span><span class="text-lg md:text-xl font-bold ml-1">kn</span>
            </p>
            <p class="text-xs md:text-sm text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)]">vento</p>
          </div>
          <div class="text-center p-4 bg-secondary rounded-xl">
            <p class="text-3xl md:text-4xl font-black text-[var(--color-accent-secondary)] dark:text-[var(--color-accent-secondary-dark)]" id="current-wind-dir">--</p>
            <p class="text-xs md:text-sm text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)]">direzione</p>
          </div>
          <div class="text-center p-4 bg-secondary rounded-xl">
            <p class="text-3xl md:text-4xl font-black">
              <span id="current-temp">--</span><span class="text-lg md:text-xl font-bold ml-1">Â°C</span>
            </p>
            <p class="text-xs md:text-sm text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)]">temperatura</p>
          </div>
          <div class="text-center p-4 bg-secondary rounded-xl">
            <p class="text-3xl md:text-4xl font-black">
              <span id="current-humidity">--</span><span class="text-lg md:text-xl font-bold ml-1">%</span>
            </p>
            <p class="text-xs md:text-sm text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)]">umiditÃ </p>
          </div>
        </div>
        
        <p class="text-xs text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)] mt-4 text-center" id="last-update">
          Aggiornato: --
        </p>
      </div>

      <!-- Hourly Forecast -->
      <div class="bg-[var(--color-bg-primary)] dark:bg-[var(--color-bg-secondary-dark)] rounded-2xl border border-gray-200 dark:border-gray-700 p-6 md:p-8 mb-8">
        <h2 class="text-lg font-bold mb-4">
          Previsione Vento Oggi
        </h2>
        
        <div id="hourly-forecast" class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-12 gap-2">
          <!-- Will be populated by JS -->
          <p class="col-span-full text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)]">Caricamento...</p>
        </div>
        
        <p class="text-xs text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)] mt-4">
          Indicazioni generali. Verifica sempre le condizioni reali prima di uscire.
        </p>
      </div>

      <!-- Daily Forecast -->
      <div class="bg-[var(--color-bg-primary)] dark:bg-[var(--color-bg-secondary-dark)] rounded-2xl border border-gray-200 dark:border-gray-700 p-6 md:p-8 mb-8">
        <h2 class="text-lg font-bold mb-4">
          Previsioni Prossimi Giorni
        </h2>
        
        <div id="daily-forecast" class="space-y-3">
          <!-- Will be populated by JS -->
          <p class="text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)]">Caricamento...</p>
        </div>
      </div>

    </div>
  </section>
</BaseLayout>

<script define:vars={{ LAT, LON }}>
  // Wind direction to compass
  function degToCompass(deg) {
    const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
    const index = Math.round(deg / 45) % 8;
    return directions[index];
  }

  // Get wind status, recommendation, and color (thresholds in knots)
  function getWindConditions(speed) {
    if (speed < 3) {
      return { status: 'Bonaccia', recommendation: 'Principianti, SUP', bgClass: 'bg-sky-100 dark:bg-sky-900/30', dotClass: 'bg-sky-500' };
    } else if (speed < 7) {
      return { status: 'Vento Leggero', recommendation: 'Tutti i livelli', bgClass: 'bg-emerald-100 dark:bg-emerald-900/30', dotClass: 'bg-emerald-500' };
    } else if (speed < 11) {
      return { status: 'Vento Moderato', recommendation: 'Velisti esperti', bgClass: 'bg-amber-100 dark:bg-amber-900/30', dotClass: 'bg-amber-500' };
    } else if (speed < 16) {
      return { status: 'Vento Forte', recommendation: 'Solo esperti', bgClass: 'bg-orange-100 dark:bg-orange-900/30', dotClass: 'bg-orange-500' };
    } else {
      return { status: 'Vento Molto Forte', recommendation: 'Sconsigliato uscire', bgClass: 'bg-red-100 dark:bg-red-900/30', dotClass: 'bg-red-500' };
    }
  }

  // Weather code to description and icon
  function getWeatherInfo(code) {
    const weatherCodes = {
      0: { desc: 'Sereno', icon: 'â˜€ï¸' },
      1: { desc: 'Poco nuvoloso', icon: 'ðŸŒ¤ï¸' },
      2: { desc: 'Parzialmente nuvoloso', icon: 'â›…' },
      3: { desc: 'Nuvoloso', icon: 'â˜ï¸' },
      45: { desc: 'Nebbia', icon: 'ðŸŒ«ï¸' },
      48: { desc: 'Nebbia gelata', icon: 'ðŸŒ«ï¸' },
      51: { desc: 'Pioggerella', icon: 'ðŸŒ§ï¸' },
      53: { desc: 'Pioggerella', icon: 'ðŸŒ§ï¸' },
      55: { desc: 'Pioggerella', icon: 'ðŸŒ§ï¸' },
      61: { desc: 'Pioggia leggera', icon: 'ðŸŒ§ï¸' },
      63: { desc: 'Pioggia', icon: 'ðŸŒ§ï¸' },
      65: { desc: 'Pioggia forte', icon: 'ðŸŒ§ï¸' },
      71: { desc: 'Neve leggera', icon: 'ðŸŒ¨ï¸' },
      73: { desc: 'Neve', icon: 'ðŸŒ¨ï¸' },
      75: { desc: 'Neve forte', icon: 'ðŸŒ¨ï¸' },
      80: { desc: 'Rovesci', icon: 'ðŸŒ¦ï¸' },
      81: { desc: 'Rovesci', icon: 'ðŸŒ¦ï¸' },
      82: { desc: 'Rovesci forti', icon: 'ðŸŒ¦ï¸' },
      95: { desc: 'Temporale', icon: 'â›ˆï¸' },
      96: { desc: 'Temporale con grandine', icon: 'â›ˆï¸' },
      99: { desc: 'Temporale con grandine', icon: 'â›ˆï¸' },
    };
    return weatherCodes[code] || { desc: 'N/D', icon: 'â“' };
  }

  // Format day name
  function getDayName(dateStr) {
    const date = new Date(dateStr);
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    if (date.toDateString() === today.toDateString()) return 'Oggi';
    if (date.toDateString() === tomorrow.toDateString()) return 'Domani';
    
    return date.toLocaleDateString('it-IT', { weekday: 'short', day: 'numeric' });
  }

  async function fetchWeather() {
    try {
      const response = await fetch(
        `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&current=temperature_2m,relative_humidity_2m,wind_speed_10m,wind_direction_10m&hourly=wind_speed_10m,wind_direction_10m&daily=weather_code,temperature_2m_max,temperature_2m_min,wind_speed_10m_max,wind_direction_10m_dominant&wind_speed_unit=kn&timezone=Europe/Rome&forecast_days=7`
      );
      
      if (!response.ok) throw new Error('Weather fetch failed');
      
      const data = await response.json();
      
      // Update current conditions
      const windSpeed = Math.round(data.current.wind_speed_10m);
      const windDir = degToCompass(data.current.wind_direction_10m);
      const temp = Math.round(data.current.temperature_2m);
      const humidity = Math.round(data.current.relative_humidity_2m);
      
      document.getElementById('current-wind-speed').textContent = windSpeed;
      document.getElementById('current-wind-dir').textContent = windDir;
      document.getElementById('current-temp').textContent = temp;
      document.getElementById('current-humidity').textContent = humidity;
      
      // Update timestamp
      const now = new Date();
      document.getElementById('last-update').textContent = 
        `Aggiornato: ${now.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' })}`;
      
      // Update sailing conditions banner
      const conditions = getWindConditions(windSpeed);
      const banner = document.getElementById('sailing-banner');
      const statusEl = document.getElementById('wind-status');
      statusEl.innerHTML = `<span class="inline-block w-3 h-3 rounded-full ${conditions.dotClass} mr-2"></span>${conditions.status}`;
      document.getElementById('recommended-for').textContent = conditions.recommendation;
      
      // Update banner background color
      banner.className = `rounded-xl p-4 mb-6 text-center ${conditions.bgClass}`;
      
      // Update hourly forecast
      const hourlyContainer = document.getElementById('hourly-forecast');
      const currentHour = new Date().getHours();
      
      let hourlyHTML = '';
      
      for (let i = currentHour; i < Math.min(currentHour + 12, 24); i++) {
        const hour = data.hourly.time[i].split('T')[1].substring(0, 5);
        const speed = Math.round(data.hourly.wind_speed_10m[i]);
        const dir = degToCompass(data.hourly.wind_direction_10m[i]);
        
        // Color based on wind speed (knots)
        let bgColor = 'bg-sky-100 dark:bg-sky-900/30';
        if (speed >= 3 && speed < 7) bgColor = 'bg-emerald-100 dark:bg-emerald-900/30';
        else if (speed >= 7 && speed < 11) bgColor = 'bg-amber-100 dark:bg-amber-900/30';
        else if (speed >= 11 && speed < 16) bgColor = 'bg-orange-100 dark:bg-orange-900/30';
        else if (speed >= 16) bgColor = 'bg-red-100 dark:bg-red-900/30';
        
        hourlyHTML += `
          <div class="text-center p-2 rounded-lg ${bgColor}">
            <p class="text-xs text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)]">${hour}</p>
            <p class="text-base font-bold">${speed}<span class="text-[10px] font-medium ml-0.5">kn</span></p>
            <p class="text-xs font-medium">${dir}</p>
          </div>
        `;
      }
      
      hourlyContainer.innerHTML = hourlyHTML;
      
      // Update daily forecast
      const dailyContainer = document.getElementById('daily-forecast');
      let dailyHTML = '';
      
      for (let i = 0; i < data.daily.time.length; i++) {
        const day = getDayName(data.daily.time[i]);
        const weather = getWeatherInfo(data.daily.weather_code[i]);
        const tempMax = Math.round(data.daily.temperature_2m_max[i]);
        const tempMin = Math.round(data.daily.temperature_2m_min[i]);
        const windMax = Math.round(data.daily.wind_speed_10m_max[i]);
        const windDir = degToCompass(data.daily.wind_direction_10m_dominant[i]);
        const windConditions = getWindConditions(windMax);
        
        dailyHTML += `
          <div class="flex items-center justify-between p-3 rounded-xl ${windConditions.bgClass}">
            <div class="flex items-center gap-3 min-w-0">
              <span class="text-2xl">${weather.icon}</span>
              <div class="min-w-0">
                <p class="font-bold">${day}</p>
                <p class="text-xs text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)] truncate">${weather.desc}</p>
              </div>
            </div>
            <div class="flex items-center gap-4 md:gap-6 text-right">
              <div>
                <p class="font-bold">${tempMax}Â° <span class="font-normal text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)]">/ ${tempMin}Â°</span></p>
              </div>
              <div class="min-w-[60px]">
                <p class="font-bold text-[var(--color-accent-primary)] dark:text-[var(--color-link-dark)]">${windMax} kn</p>
                <p class="text-xs text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)]">${windDir}</p>
              </div>
            </div>
          </div>
        `;
      }
      
      dailyContainer.innerHTML = dailyHTML;
      
    } catch (error) {
      console.error('Weather fetch error:', error);
      document.getElementById('hourly-forecast').innerHTML = 
        '<p class="col-span-full text-red-500">Errore nel caricamento dei dati meteo</p>';
      document.getElementById('daily-forecast').innerHTML = 
        '<p class="text-red-500">Errore nel caricamento dei dati meteo</p>';
    }
  }
  
  // Fetch on load
  fetchWeather();
  
  // Refresh every 10 minutes
  setInterval(fetchWeather, 10 * 60 * 1000);
</script>

