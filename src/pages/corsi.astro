---
import BaseLayout from '../layouts/BaseLayout.astro';
import EventCard from '../components/EventCard.astro';
import { getEntry, getCollection } from 'astro:content';
import pricingData from '../data/pricing.json';
import events from '../data/events.json';
import board from '../data/board.json';

// Get page content
const page = await getEntry('pages', 'corsi');

// Get all courses from content collection, sorted by order
const allCourses = await getCollection('courses');
const courses = allCourses.sort((a, b) => a.data.order - b.data.order);

// Get pricing cards from content collection, sorted by order
const allPricing = await getCollection('pricing');
const pricingCards = allPricing.sort((a, b) => a.data.order - b.data.order);

// Get upcoming courses from events
const now = new Date();
const upcomingCourses = events.events
  .filter(event => event.type === 'corso' && new Date(event.date) >= now)
  .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());
---

<BaseLayout title={page.data.title} description={page.data.description}>
  <!-- Hero image -->
  <section class="relative h-[35vh] min-h-[250px] overflow-hidden">
    <img 
      src="images/corsi/scuola-vela-azione.jpg" 
      alt="Allievi della scuola vela sul Lago Maggiore"
      class="absolute inset-0 w-full h-full object-cover"
    />
  </section>
  
  <!-- Title bar -->
  <section class="bg-[var(--color-accent-primary)] dark:bg-[#0D1B2A] py-6 md:py-8">
    <div class="max-w-6xl mx-auto px-4 lg:px-6">
      <h1 class="text-2xl md:text-3xl font-black text-white">{page.data.title}</h1>
      {page.data.subtitle && (
        <p class="text-sm md:text-base text-white/70 mt-2 max-w-2xl">{page.data.subtitle}</p>
      )}
    </div>
  </section>


  <!-- Course Types -->
  <section class="py-12 md:py-16">
    <div class="max-w-6xl mx-auto px-4 lg:px-6">
      <h2 class="text-2xl font-black mb-8" style="font-size: var(--text-2xl);">
        I Nostri Corsi
      </h2>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        {courses.map(async (course) => {
          const { Content } = await course.render();
          return (
            <article class="bg-[var(--color-bg-secondary)] dark:bg-[var(--color-bg-secondary-dark)] rounded-xl p-6 border border-gray-200 dark:border-gray-700">
              <div class="w-14 h-14 bg-[var(--color-accent-primary)] dark:bg-[var(--color-accent-primary-dark)] rounded-xl flex items-center justify-center mb-4">
                <span class="text-2xl">{course.data.icon === 'yacht' ? 'üõ•Ô∏è' : '‚õµ'}</span>
              </div>
              
              <h3 class="text-xl font-bold mb-1">{course.data.title}</h3>
              <p class="text-sm text-[var(--color-accent-primary)] dark:text-[var(--color-accent-primary-dark)] font-semibold mb-3">
                {course.data.subtitle}
              </p>
              
              <div class="text-sm text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)] mb-4 markdown-content">
                <Content />
              </div>
              
              <ul class="text-sm space-y-2 mb-4">
                <li class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-green-600 dark:text-green-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                  </svg>
                  <span><strong>Durata:</strong> {course.data.duration}</span>
                </li>
                <li class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-green-600 dark:text-green-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                  </svg>
                  <span><strong>Periodo:</strong> {course.data.period}</span>
                </li>
                <li class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-green-600 dark:text-green-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                  </svg>
                  <span><strong>Imbarcazione:</strong> {course.data.boatType}</span>
                </li>
              </ul>
              
              <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
                <p class="text-2xl font-black text-[var(--color-accent-primary)] dark:text-[var(--color-accent-primary-dark)]">
                  ‚Ç¨{course.data.price.toFixed(2)}
                  <span class="text-xs font-normal text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)]">
                    {course.data.priceNote}
                  </span>
                </p>
              </div>
            </article>
          );
        })}
      </div>
    </div>
  </section>

  <!-- Upcoming Courses -->
  {upcomingCourses.length > 0 && (
    <section class="py-12 md:py-16 bg-[var(--color-bg-secondary)] dark:bg-[var(--color-bg-secondary-dark)]">
      <div class="max-w-6xl mx-auto px-4 lg:px-6">
        <h2 class="text-2xl font-black mb-8" style="font-size: var(--text-2xl);">
          Prossimi Corsi
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 lg:gap-6">
          {upcomingCourses.map((event) => (
            <EventCard event={event} />
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Pricing -->
  <section id="quote" class="py-12 md:py-16">
    <div class="max-w-6xl mx-auto px-4 lg:px-6">
      <h2 class="text-2xl font-black mb-8" style="font-size: var(--text-2xl);">
        Quote e Tariffe
      </h2>
      
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        {pricingCards.map((card) => (
          <div class="bg-[var(--color-bg-secondary)] dark:bg-[var(--color-bg-secondary-dark)] rounded-xl p-6 border border-gray-200 dark:border-gray-700">
            <h3 class="font-bold text-lg mb-1">{card.data.title}</h3>
            {card.data.note && (
              <p class="text-sm text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)] mb-4">{card.data.note}</p>
            )}
            <ul class="space-y-3">
              {card.data.items.map((item) => (
                <li class="flex justify-between items-start">
                  <div>
                    <p class="font-medium">{item.name}</p>
                    {item.note && (
                      <p class="text-xs text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)]">{item.note}</p>
                    )}
                  </div>
                  <p class="font-bold text-[var(--color-accent-primary)] dark:text-[var(--color-accent-primary-dark)]">
                    ‚Ç¨{item.price.toFixed(2)}
                  </p>
                </li>
              ))}
            </ul>
            {card.data.discounts && card.data.discounts.length > 0 && (
              <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                <p class="text-sm text-green-600 dark:text-green-400 font-medium">
                  üí° {card.data.discounts[0].description}: {card.data.discounts[0].discount}
                </p>
              </div>
            )}
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Registration Form -->
  <section id="iscrizione" class="py-12 md:py-16 bg-[var(--color-bg-secondary)] dark:bg-[var(--color-bg-secondary-dark)]">
    <div class="max-w-4xl mx-auto px-4 lg:px-6">
      <h2 class="text-2xl font-black mb-4 text-center" style="font-size: var(--text-2xl);">
        Iscriviti ai Corsi
      </h2>
      <p class="text-center text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)] mb-8">
        Segui questi semplici passaggi per iscriverti a uno dei nostri corsi.
      </p>
      
      <!-- Modulo di Iscrizione -->
      <div class="bg-[var(--color-bg-primary)] dark:bg-[var(--color-bg-primary-dark)] rounded-xl p-8 border border-gray-200 dark:border-gray-700">
        <h3 class="font-bold text-lg mb-4 text-center">Modulo di Iscrizione</h3>
        
        <!-- Istruzioni -->
        <ol class="space-y-4 mb-8 text-sm">
          <li class="flex gap-3">
            <span class="flex-shrink-0 w-6 h-6 rounded-full bg-[var(--color-accent-primary)] text-white flex items-center justify-center text-xs font-bold">1</span>
            <span><strong>Scarica</strong> il modulo di iscrizione cliccando il bottone qui sotto</span>
          </li>
          <li class="flex gap-3">
            <span class="flex-shrink-0 w-6 h-6 rounded-full bg-[var(--color-accent-primary)] text-white flex items-center justify-center text-xs font-bold">2</span>
            <span><strong>Compila</strong> tutti i campi richiesti e <strong>firma</strong> il modulo</span>
          </li>
          <li class="flex gap-3">
            <span class="flex-shrink-0 w-6 h-6 rounded-full bg-[var(--color-accent-primary)] text-white flex items-center justify-center text-xs font-bold">3</span>
            <span><strong>Invia</strong> il modulo compilato e firmato via email alla segreteria</span>
          </li>
        </ol>
        
        <!-- Bottoni -->
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <a
            href="documenti/iscrizione-scuola-vela.pdf"
            download
            class="inline-flex items-center justify-center gap-2 px-6 py-3 bg-[var(--color-accent-primary)] dark:bg-[var(--color-accent-primary-dark)] text-white font-bold uppercase tracking-wide rounded-lg hover:opacity-90 transition-opacity touch-target"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            Scarica Modulo
          </a>
          <a
            href={`mailto:${board.contact.email}?subject=Iscrizione Corso Vela - Modulo Compilato`}
            class="inline-flex items-center justify-center gap-2 px-6 py-3 bg-[var(--color-accent-secondary)] dark:bg-[var(--color-accent-secondary-dark)] text-white font-bold uppercase tracking-wide rounded-lg hover:opacity-90 transition-opacity touch-target"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
            </svg>
            Invia alla Segreteria
          </a>
        </div>
      </div>
      
      <!-- Bank Details -->
      <div class="mt-8 p-6 bg-[var(--color-bg-primary)] dark:bg-[var(--color-bg-primary-dark)] rounded-xl border border-gray-200 dark:border-gray-700">
        <h3 class="font-bold mb-4">Coordinate Bancarie per Bonifico</h3>
        <dl class="space-y-2 text-sm">
          <div class="flex flex-col sm:flex-row sm:gap-4">
            <dt class="font-medium text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)] sm:w-32">Intestatario:</dt>
            <dd>{pricingData.bankDetails.accountHolder}</dd>
          </div>
          <div class="flex flex-col sm:flex-row sm:gap-4">
            <dt class="font-medium text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)] sm:w-32">Banca:</dt>
            <dd>{pricingData.bankDetails.bankName} - {pricingData.bankDetails.branch}</dd>
          </div>
          <div class="flex flex-col sm:flex-row sm:gap-4">
            <dt class="font-medium text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)] sm:w-32">IBAN:</dt>
            <dd class="font-mono text-sm break-all">{pricingData.bankDetails.iban}</dd>
          </div>
        </dl>
      </div>
    </div>
  </section>

  <!-- Safeguarding Note -->
  <section class="py-8 md:py-12">
    <div class="max-w-4xl mx-auto px-4 lg:px-6">
      <a href="safeguarding" class="flex items-center gap-4 p-5 bg-[var(--color-accent-primary)]/5 dark:bg-[var(--color-accent-primary-dark)]/10 rounded-xl border border-[var(--color-accent-primary)]/20 dark:border-[var(--color-accent-primary-dark)]/20 hover:border-[var(--color-accent-primary)] dark:hover:border-[var(--color-accent-primary-dark)] transition-colors group">
        <div class="w-12 h-12 bg-[var(--color-accent-primary)] dark:bg-[var(--color-accent-primary-dark)] rounded-xl flex items-center justify-center flex-shrink-0">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
          </svg>
        </div>
        <div class="flex-1">
          <p class="font-bold">Safeguarding - Tutela dei Minori</p>
          <p class="text-sm text-[var(--color-text-secondary)] dark:text-[var(--color-text-secondary-dark)]">
            Il CNC ha implementato un modello organizzativo a tutela dei minori come previsto dalla legge.
          </p>
        </div>
        <svg class="w-5 h-5 text-[var(--color-accent-primary)] dark:text-[var(--color-accent-primary-dark)] group-hover:translate-x-1 transition-transform flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      </a>
    </div>
  </section>
</BaseLayout>
